suite: test ArgoCD Project
release:
  name: test-release
  namespace: test-namespace
templates:
  - argocd-project.yaml
tests:
  - it: should conform to default values
    asserts:
      - isKind:
          of: AppProject
      - equal:
          path: metadata.name
          value: test-release
      - equal:
          path: metadata.namespace
          value: default
      - contains:
          path: metadata.finalizers
          content: resources-finalizer.argocd.argoproj.io
      - lengthEqual:
          path: metadata.finalizers
          count: 1
      - equal:
          path: spec.description
          value: Projet 'test-release'
      - contains:
          path: spec.sourceRepos
          content: 'https://github.com/NValembois/**'
      - contains:
          path: spec.sourceRepos
          content: 'https://nvalembois.github.io/charts'
      - lengthEqual:
          path: spec.sourceRepos
          count: 2
      - contains:
          path: spec.destinations
          content:
            server: 'https://kubernetes.default.svc'
            name: 'in-cluster'
            namespace: test-release
      - lengthEqual:
          path: spec.destinations
          count: 1
      - notExists:
          path: clusterResourceWhitelist
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: ''
            kind: ConfigMap
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: ''
            kind: PersistentVolumeClaim
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: ''
            kind: Pod
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: ''
            kind: Secret
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: ''
            kind: ServiceAccount
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: ''
            kind: Service
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: apps
            kind: DaemonSet
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: apps
            kind: Deployment
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: apps
            kind: ReplicaSet
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: apps
            kind: StatefulSet
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: autoscaling
            kind: HorizontalPodAutoscaler
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: batch
            kind: CronJob
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: batch
            kind: Job
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: networking.k8s.io
            kind: Ingress
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: networking.k8s.io
            kind: NetworkPolicy
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: bitnami.com
            kind: SealedSecret
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: cert-manager.io
            kind: CertificateRequest
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: cert-manager.io
            kind: Certificate
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: cert-manager.io
            kind: Issuer
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: job.min.io
            kind: MinIOJob
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: metrics.k8s.io
            kind: PodMetrics
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: monitoring.coreos.com
            kind: PodMonitor
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: monitoring.coreos.com
            kind: ServiceMonitor
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: monitoring.coreos.com
            kind: PrometheusRule
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: monitoring.grafana.com
            kind: MetricsInstance
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: policy
            kind: PodDisruptionBudget
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: postgresql.cnpg.io
            kind: Backup
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: postgresql.cnpg.io
            kind: Cluster
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: postgresql.cnpg.io
            kind: ScheduledBackup
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: rbac.authorization.k8s.io
            kind: RoleBinding
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: rbac.authorization.k8s.io
            kind: Role
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: s3.onyxia.sh
            kind: Path
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: snapshot.storage.k8s.io
            kind: VolumeSnapshot
      - lengthEqual:
          path: spec.namespaceResourceWhitelist
          count: 33
      - equal:
          path: spec.orphanedResources.warn
          value: false
      - notExists:
          path: spec.roles
      - notExists:
          path: spec.syncWindows
      - equal:
          path: spec.permitOnlyProjectScopedClusters
          value: false
      - notExists:
          path: spec.sourceNamespaces
  - it: should use additional values
    set:
      additionalSourceRepos:
        - 'additionalSourceRepos-{{ .Release.Name }}'
      additionnalDestinations:
        - server: server
        - name: name
        - server: serverName
          name: nameServer
      additionalClusterResourceWhitelist:
        - group: additionalClusterResourceWhitelist
          kind: additionalClusterResourceWhitelist
      additionalNamespaceResourceWhitelist:
        - group: additionalNamespaceResourceWhitelist
          kind: additionalNamespaceResourceWhitelist
      roles:
        - roles
      syncWindows:
        - syncWindows
      sourceNamespaces:
        - sourceNamespaces
    asserts:
      - isKind:
          of: AppProject
      - equal:
          path: metadata.name
          value: test-release
      - equal:
          path: metadata.namespace
          value: default
      - contains:
          path: metadata.finalizers
          content: resources-finalizer.argocd.argoproj.io
          count: 1
      - equal:
          path: spec.description
          value: Projet 'test-release'
      - contains:
          path: spec.sourceRepos
          content: https://github.com/NValembois/**
      - contains:
          path: spec.sourceRepos
          content: https://nvalembois.github.io/charts
      - contains:
          path: spec.sourceRepos
          content: additionalSourceRepos-test-release
      - lengthEqual:
          path: spec.sourceRepos
          count: 3
      - contains:
          path: spec.destinations
          content:
            server: https://kubernetes.default.svc
            name: in-cluster
            namespace: test-release
          count: 1
      - contains:
          path: spec.clusterResourceWhitelist
          content:
            group: additionalClusterResourceWhitelist
            kind: additionalClusterResourceWhitelist
          count: 1
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: ''
            kind: ConfigMap
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: ''
            kind: PersistentVolumeClaim
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: ''
            kind: Pod
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: ''
            kind: Secret
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: ''
            kind: ServiceAccount
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: ''
            kind: Service
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: apps
            kind: DaemonSet
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: apps
            kind: Deployment
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: apps
            kind: ReplicaSet
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: apps
            kind: StatefulSet
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: autoscaling
            kind: HorizontalPodAutoscaler
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: batch
            kind: CronJob
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: batch
            kind: Job
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: networking.k8s.io
            kind: Ingress
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: networking.k8s.io
            kind: NetworkPolicy
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: bitnami.com
            kind: SealedSecret
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: cert-manager.io
            kind: CertificateRequest
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: cert-manager.io
            kind: Certificate
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: cert-manager.io
            kind: Issuer
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: job.min.io
            kind: MinIOJob
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: metrics.k8s.io
            kind: PodMetrics
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: monitoring.coreos.com
            kind: PodMonitor
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: monitoring.coreos.com
            kind: ServiceMonitor
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: monitoring.coreos.com
            kind: PrometheusRule
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: monitoring.grafana.com
            kind: MetricsInstance
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: policy
            kind: PodDisruptionBudget
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: postgresql.cnpg.io
            kind: Backup
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: postgresql.cnpg.io
            kind: Cluster
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: postgresql.cnpg.io
            kind: ScheduledBackup
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: rbac.authorization.k8s.io
            kind: RoleBinding
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: rbac.authorization.k8s.io
            kind: Role
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: s3.onyxia.sh
            kind: Path
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: snapshot.storage.k8s.io
            kind: VolumeSnapshot
      - contains:
          path: spec.namespaceResourceWhitelist
          content:
            group: additionalNamespaceResourceWhitelist
            kind: additionalNamespaceResourceWhitelist
      - lengthEqual:
          path: spec.namespaceResourceWhitelist
          count: 34
      - equal:
          path: spec.orphanedResources.warn
          value: false
      - contains:
          path: spec.roles
          content: 'roles'
          count: 1
      - contains:
          path: spec.syncWindows
          content: 'syncWindows'
          count: 1
      - equal:
          path: spec.permitOnlyProjectScopedClusters
          value: false
      - contains:
          path: spec.sourceNamespaces
          content: 'sourceNamespaces'
          count: 1
